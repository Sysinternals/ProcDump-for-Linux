# Azure build pipelines for Procdump-for-Linux
trigger:
  branches:
    include:
      - release/*
    exclude:
      - dev/*
      - test/*

pr:
  - master

stages:
 - stage: "Build"
   jobs:
    - job: "ProcDump_Run_Unit_Tests"
      pool:
       vmImage: 'ubuntu-latest'
      steps:
      - script: |
          sudo apt update
          sudo apt install -y gdb stress-ng zlib1g-dev clang
        displayName: 'Setup build environment'

      - script: |
          clang --version
          clang++ --version
        displayName: 'List compiler versions'

      - template: templates/build.yaml

      - script: |
          cd build/tests/integration
          sudo ./run.sh
        displayName: 'Run unit tests'

      - script: |
          mkdir $(Build.ArtifactStagingDirectory)/logs
          cp /var/log/syslog $(Build.ArtifactStagingDirectory)/logs
          cp /var/tmp/procdumpprofiler.log $(Build.ArtifactStagingDirectory)/logs
        displayName: 'Copy log artifacts to staging'
        condition: always()

      - task: PublishBuildArtifacts@1
        condition: always()
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/logs/syslog'
          ArtifactName: 'syslog'
          publishLocation: 'Container'

      - task: PublishBuildArtifacts@1
        condition: always()
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/logs/procdumpprofiler.log'
          ArtifactName: 'procdumpprofiler.log'
          publishLocation: 'Container'

    - job: "Build_ProcDump"
      pool:
       vmImage: 'ubuntu-latest'
      steps:
      - template: templates/build.yaml
      displayName: 'Build ProcDump'