# Azure build pipelines for Procdump-for-Linux

resources:
  repositories:
  - repository: ProcDump
    type: github
    endpoint: sysinternals
    name: Sysinternals/ProcDump-for-Linux


trigger:
  branches:
    include:
      - release/*
    exclude:
      - dev/*
      - test/*

pr:
  - master

stages:
 - stage: "Build"
   jobs:
    - job: "ProcDump_Run_Unit_Tests"
      pool:
       vmImage: 'ubuntu-latest'
      steps:
      - checkout: ProcDump
      - script: |
          sudo apt update
          sudo apt install -y gdb stress-ng zlib1g-dev
        displayName: 'Setup build environment'
      
      - script: |
          make
        displayName: 'Build ProcDump test binary'

      - script: |
          sudo ./tests/integration/run.sh
        displayName: 'Run unit tests'   

    - job: "Build_ProcDump_Ubuntu_18_04_Package"
      pool: "Ubuntu_18_Package_Build"
      condition: not(eq(variables['Build.Reason'], 'PullRequest'))        
      dependsOn:
       - ProcDump_Run_Unit_Tests
      steps:
      - checkout: ProcDump
      - script: |
          make
        displayName: 'Build Ubuntu ProcDump 18.04 Binary'

      - script: |
          export REVISION=$(Build.BuildId)
          make release
          make deb
        displayName: 'Build ProcDump Procmon 18.04 Package'

      - task: CopyFiles@2
        inputs:
          Contents: '$(Build.SourcesDirectory)/pkgbuild/DEBS/amd64/*.deb'
          TargetFolder: '$(Build.ArtifactStagingDirectory)/Ubuntu_18.04'
        displayName: 'Copy build to staging'
    
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/Ubuntu_18.04'
          ArtifactName: 'Ubuntu_18_04_drop'
          publishLocation: 'Container'
        displayName: 'Copy DEB package to artifacts'
    
    - job: 'Build_ProcDump_CentOS_8_Package'
      pool: 'CentOS_Package_Build'
      condition: not(eq(variables['Build.Reason'], 'PullRequest'))
      dependsOn:
       - ProcDump_Run_Unit_Tests      
      steps:
        - checkout: ProcDump
        - script: |
            make
          displayName: "Build CentOS ProcDump 8 Binary"

        - script: |
            export REVISION=$(Build.BuildId)
            make release
            make rpm
          displayName: 'Build ProcDump CentOS 8 Package'

        - task: CopyFiles@2
          inputs:
            Contents: '$(Build.SourcesDirectory)/pkgbuild/RPMS/x86_64/*.rpm'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/CentOS_8'
          displayName: 'Copy build artifacts to staging'
      
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/CentOS_8'
            ArtifactName: 'CentOS_8_drop'
            publishLocation: 'Container'
          displayName: 'Copy RPM package to artifacts'

 - stage: Sign
   jobs:
    - job: "Sign_ProcDump_Ubuntu_18_04"
      pool: "Ubuntu_18_Package_Build"
      condition: eq(variables['Sign'], 'true')
      workspace:
        clean: all
      steps:
      
      - task: DownloadPipelineArtifact@2
        inputs:
          source: 'current'
          artifactName: 'Ubuntu_18_04_drop'
          targetPath: '$(Build.SourcesDirectory)/Ubuntu_18_04_drop'
           
      - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
        displayName: 'ESRP CodeSigning DEB'
        inputs:
          ConnectedServiceName: 'Sysinternals ESRP CodeSigning'
          FolderPath: '$(Pipeline.Workspace)/Ubuntu_18_04_drop'
          Pattern: '*.deb'
          signConfigType: inlineSignParams
          inlineOperation: |
            [
              {
                "keyCode": "CP-450779-Pgp",
                "OperationCode": "LinuxSign",
                "Parameters": {},
                "ToolName": "sign",
                "ToolVersion": "1.0"
              }
            ]

      - task: CopyFiles@2
        inputs:
          Contents: '$(Build.SourcesDirectory)/Ubuntu_18_04_drop/pkgbuild/*.deb'
          TargetFolder: '$(Build.ArtifactStagingDirectory)/Ubuntu_18_04_Signed/'
        displayName: 'Copy signed DEB package to staging'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/Ubuntu_18_04_Signed/'
          ArtifactName: 'Ubuntu_18_04_Signed'
          publishLocation: 'Container'
        displayName: 'Copy signed DEB package to artifacts'

    - job: "Sign_ProcDump_CentOS_8"
      pool: "CentOS_Package_Build"
      condition: eq(variables['Sign'], 'true')
      workspace:
        clean: all
      steps:

      - task: DownloadPipelineArtifact@2
        inputs:
          source: 'current'
          artifactName: 'CentOS_8_drop'
          targetPath: '$(Build.SourcesDirectory)/CentOS_8_drop'

      - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
        displayName: 'ESRP CodeSigning DEB'
        inputs:
          ConnectedServiceName: 'Sysinternals ESRP CodeSigning'
          FolderPath: '$(Build.SourcesDirectory)/CentOS_8_drop'
          Pattern: '*.rpm'
          signConfigType: inlineSignParams
          inlineOperation: |
            [
              {
                "keyCode": "CP-450779-Pgp",
                "OperationCode": "LinuxSign",
                "Parameters": {},
                "ToolName": "sign",
                "ToolVersion": "1.0"
              }
            ]
          
      - task: CopyFiles@2
        inputs:
          Contents: '$(Build.SourcesDirectory)/CentOS_8_drop/pkgbuild/*.rpm'
          TargetFolder: '$(Build.ArtifactStagingDirectory)/CentOS_8_Signed/'
        displayName: 'Copy signed DEB package to staging'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/CentOS_8_Signed/'
          ArtifactName: 'CentOS_8_Signed'
          publishLocation: 'Container'
        displayName: 'Copy signed DEB package to artifacts'          